<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGI Explorer - Test Runner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            color: #6366f1;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 10px;
        }
        
        .test-controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        
        button {
            background-color: #6366f1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        button:hover {
            background-color: #4f46e5;
        }
        
        button.secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        
        button.secondary:hover {
            background-color: #d1d5db;
        }
        
        .test-options {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9fafb;
            border-radius: 8px;
        }
        
        .test-item {
            margin-bottom: 8px;
        }
        
        .test-log {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            margin-bottom: 20px;
        }
        
        .test-log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #374151;
        }
        
        .test-log-entry.success {
            color: #10b981;
        }
        
        .test-log-entry.error {
            color: #ef4444;
        }
        
        .test-log-entry.info {
            color: #6366f1;
        }
        
        .test-summary {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
        }
        
        .test-summary h2 {
            margin-top: 0;
            color: #6366f1;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #6366f1;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .passed {
            color: #10b981;
        }
        
        .failed {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <h1>AGI Explorer Test Runner</h1>
    
    <div class="progress-bar">
        <div class="progress-fill" id="testProgress"></div>
    </div>
    
    <div class="test-controls">
        <button id="runAllTests">Run All Tests</button>
        <button id="runSelectedTests">Run Selected</button>
        <button id="clearLog" class="secondary">Clear Log</button>
    </div>
    
    <div class="test-options">
        <h2>Select Tests to Run</h2>
        <div class="test-item">
            <input type="checkbox" id="testBrainViz" checked>
            <label for="testBrainViz">Brain Visualization</label>
        </div>
        <div class="test-item">
            <input type="checkbox" id="testGlitchEffect" checked>
            <label for="testGlitchEffect">Glitch Effect</label>
        </div>
        <div class="test-item">
            <input type="checkbox" id="testNavLinks" checked>
            <label for="testNavLinks">Navigation Links</label>
        </div>
        <div class="test-item">
            <input type="checkbox" id="testSimControls" checked>
            <label for="testSimControls">Simulation Controls</label>
        </div>
        <div class="test-item">
            <input type="checkbox" id="testSimExecution" checked>
            <label for="testSimExecution">Simulation Execution</label>
        </div>
        <div class="test-item">
            <input type="checkbox" id="testPopup" checked>
            <label for="testPopup">Popup Functionality</label>
        </div>
    </div>
    
    <h2>Test Log</h2>
    <div class="test-log" id="testLog">
        <div class="test-log-entry info">Test runner initialized. Select tests and click "Run" to begin testing.</div>
    </div>
    
    <div class="test-summary" id="testSummary">
        <h2>Test Summary</h2>
        <p>No tests have been run yet.</p>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const runAllTestsBtn = document.getElementById('runAllTests');
            const runSelectedTestsBtn = document.getElementById('runSelectedTests');
            const clearLogBtn = document.getElementById('clearLog');
            const testLog = document.getElementById('testLog');
            const testSummary = document.getElementById('testSummary');
            const testProgress = document.getElementById('testProgress');
            
            // Test mapping
            const testMapping = {
                'testBrainViz': 'brainVisualization',
                'testGlitchEffect': 'glitchEffect',
                'testNavLinks': 'navigationLinks',
                'testSimControls': 'simulationControls',
                'testSimExecution': 'simulationExecution',
                'testPopup': 'popupFunctionality'
            };
            
            // Log function
            function log(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = `test-log-entry ${type}`;
                entry.textContent = message;
                testLog.appendChild(entry);
                testLog.scrollTop = testLog.scrollHeight;
            }
            
            // Clear log
            clearLogBtn.addEventListener('click', function() {
                testLog.innerHTML = '';
                log('Log cleared.', 'info');
            });
            
            // Run all tests
            runAllTestsBtn.addEventListener('click', function() {
                // Check all checkboxes
                Object.keys(testMapping).forEach(id => {
                    document.getElementById(id).checked = true;
                });
                
                runTests();
            });
            
            // Run selected tests
            runSelectedTestsBtn.addEventListener('click', function() {
                runTests();
            });
            
            // Main test runner function
            async function runTests() {
                log('Opening AGI Explorer in a new window for testing...', 'info');
                
                // Open AGI Explorer in a new window
                const testWindow = window.open('index.html', 'agiExplorerTest', 'width=1200,height=800');
                
                if (!testWindow) {
                    log('Failed to open test window. Please allow popups for this site.', 'error');
                    return;
                }
                
                // Wait for the window to load
                log('Waiting for AGI Explorer to load...', 'info');
                
                await new Promise(resolve => {
                    testWindow.addEventListener('load', resolve);
                    // Fallback in case load event doesn't fire
                    setTimeout(resolve, 3000);
                });
                
                log('AGI Explorer loaded. Initializing tests...', 'info');
                
                // Get selected tests
                const selectedTests = Object.entries(testMapping)
                    .filter(([id]) => document.getElementById(id).checked)
                    .map(([, name]) => name);
                
                if (selectedTests.length === 0) {
                    log('No tests selected!', 'error');
                    testWindow.close();
                    return;
                }
                
                log(`Running ${selectedTests.length} tests...`, 'info');
                
                // Reset progress bar
                testProgress.style.width = '0%';
                
                try {
                    // Create tester in the test window
                    testWindow.eval(`
                        if (!window.tester) {
                            // Load the test API script
                            const script = document.createElement('script');
                            script.src = 'test-api.js';
                            document.head.appendChild(script);
                            
                            // Wait for script to load
                            await new Promise(resolve => {
                                script.onload = resolve;
                            });
                            
                            window.tester = new window.AGIExplorerTester();
                        }
                    `);
                    
                    // Wait for tester to be available
                    await new Promise(resolve => {
                        const checkTester = () => {
                            if (testWindow.tester) {
                                resolve();
                            } else {
                                setTimeout(checkTester, 100);
                            }
                        };
                        checkTester();
                    });
                    
                    // Run tests
                    const results = await testWindow.tester.runTests(selectedTests);
                    
                    // Update progress bar
                    testProgress.style.width = '100%';
                    
                    // Log results
                    log(`Test run completed. ${results.passed} passed, ${results.failed} failed.`, 
                        results.failed === 0 ? 'success' : 'error');
                    
                    // Update test summary
                    updateTestSummary(results);
                    
                    // Close test window after a delay
                    setTimeout(() => {
                        testWindow.close();
                    }, 1000);
                    
                } catch (error) {
                    log(`Error running tests: ${error.message}`, 'error');
                    testWindow.close();
                }
            }
            
            function updateTestSummary(results) {
                // Create summary HTML
                let summaryHTML = `<h2>Test Summary</h2>`;
                
                if (results.total === 0) {
                    summaryHTML += `<p>No tests were run.</p>`;
                } else {
                    const successRate = Math.round((results.passed / results.total) * 100);
                    
                    summaryHTML += `
                        <p>${results.passed} of ${results.total} tests passed (${successRate}%).</p>
                        <ul>
                    `;
                    
                    results.tests.forEach(test => {
                        const statusClass = test.status === 'PASSED' ? 'passed' : 'failed';
                        summaryHTML += `<li class="${statusClass}">${test.name}: ${test.status}</li>`;
                        
                        if (test.error) {
                            summaryHTML += `<li class="failed" style="margin-left: 20px; font-size: 0.9em;">${test.error}</li>`;
                        }
                    });
                    
                    summaryHTML += `</ul>`;
                }
                
                testSummary.innerHTML = summaryHTML;
            }
        });
    </script>
</body>
</html>